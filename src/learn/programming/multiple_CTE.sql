USE [AdventureWorks2019]
GO

-- # Multiple CTE: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ CTE ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤ join ‡∏Å‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á

-- üîπ CTE ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 1: ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ
WITH Sales_CTE ([SalesPersonID], [TotalSales], [SaleYear]) AS (
    SELECT
        SalesPersonID,           -- ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
        SUM(TotalDue),           -- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ
        YEAR(OrderDate)          -- ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (‡∏ï‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà OrderDate)
    FROM
        [Sales].[SalesOrderHeader]
    WHERE
        SalesPersonID IS NOT NULL -- ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
    GROUP BY
        SalesPersonID,
        YEAR(OrderDate)          -- ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ
),

-- üîπ CTE ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2: ‡∏î‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Sales Quota) ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ
     Sales_Quota_CTE ([BusinessEntityID], [SalesQuota], [SalesQuotaYear]) AS (
         SELECT
             BusinessEntityID,       -- ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á quota)
             SUM(SalesQuota),        -- ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ
             YEAR(QuotaDate)         -- ‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏à‡∏≤‡∏Å QuotaDate)
         FROM
             [Sales].[SalesPersonQuotaHistory]
         GROUP BY
             BusinessEntityID,
             YEAR(QuotaDate)         -- ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ
     )

-- üî∏ Main Query: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° CTE ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
SELECT
    SalesPersonID,             -- ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
    SaleYear,                  -- ‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
    TotalSales,                -- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°
    SalesQuotaYear,            -- ‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    SalesQuota                 -- ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏°
FROM
    Sales_CTE
        INNER JOIN Sales_Quota_CTE
                   ON Sales_Quota_CTE.BusinessEntityID = Sales_CTE.SalesPersonID   -- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                       AND Sales_CTE.SaleYear = Sales_Quota_CTE.SalesQuotaYear         -- ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
ORDER BY
    SalesPersonID,
    SaleYear;                 -- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ
